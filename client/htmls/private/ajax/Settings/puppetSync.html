<style>
  .table > thead > tr > th, .table > tbody > tr > th, .table > tfoot > tr > th, .table > thead > tr > td, .table > tbody > tr > td, .table > tfoot > tr > td {
    border-top: 0px !important;
  }

  tr.show-settings:hover .settings{
    display:block;
  }

  div.settings{
    display:none;
    width: 32px;
    height: 18px;
  }
  .dropdown-content{
    border-radius: 5px;
      left: -30px;
      min-width: 98px;
      right: 0;
  }
  .show-settings input{
    border: 1px solid #999;
  }
  .show-settings input, span{
    height: 20px;
  }

</style>

<div class="clearfix"></div>
<ul class="nav nav-tabs " role="tablist">
  <li class="active"><a href="#organiz" role="tab" data-toggle="tab">Nodes</a></li>
</ul>

<!-- Tab panes -->
<div  class="tab-content nodeListContainer">
  <div  class="tab-pane active tabContent table-responsive" id="organiz" style="display:none">
    <table class="table table-hover table-bordered" style="font-size:13px;margin-bottom:55px";>
    
    <thead>
      <tr>
        <th style="text-align: center">Node Name</th>
        <th style="text-align: center">IP Address</th>
        <th style="text-align: center">Platform</th>
        <th style="text-align: center">Environment</th>
        <th style="text-align: center">Actions</th>
      </tr>
    </thead>
    <tbody>
  

    </tbody>
  </table>
   <footer class="footer">
      <div style="text-align:center" class="clearfix form-actions">
        <div>
            <input type="button" id="buttonForIP" style="margin-left:200px;" value="Import Nodes" class="btn btn-primary showChefImportNodesModalBtn">
        </div>
      </div>
    </footer>
  <!-- <div style="text-align:center"> <input type="button" class="btn btn-primary showChefImportNodesModalBtn" value="Import Nodes"/> </div> -->

</div>

</div>  

<div class="modal fade" id="chefImportNodesModal" data-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="" id="myForm12" autocomplete="off">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Import Nodes</h4>
      </div>
      <div class="modal-body modalbody-height">
         
          
          <div class="col-lg-6">
            
              <label for="exampleInputEmail1">Organization</label>
                <select id="puppetImportOrgSelect"  class="width-100 aaa" disabled>
                  
                </select>
            
          </div>

          

          <div class="col-lg-6 topNew">  
              <label for="exampleInputEmail1">Business Groups<span class="control-label redSpan">&nbsp;*</span></label>

              <select id="puppetImportBgSelect"  class="width-100 aaaaa" cdata="catalyst" cat-validation="required" autofocus>

                
              </select>
            
          </div>


          
          
        <div class="col-lg-6" style="display:none">
          
            <label for="exampleInputEmail1">Environment<span class="control-label redSpan">&nbsp;*</span></label>
            <div class="">
              <select id="puppetImportEnvSelect"  class="width-100" >
                    
              </select>
            </div>
          
        </div>

          <div class="col-lg-6" style="margin-top:20px;">
            <label for="exampleInputEmail1">Project<span class="control-label redSpan">&nbsp;*</span></label>
            
              <select id="puppetImportProjectSelect"  class="width-100">
              </select>
            
          </div>

          <div class="col-lg-6 credentialSection" style="margin-top:20px;">
        
            <label for="exampleInputEmail1">Username<span class="control-label redSpan">&nbsp;*</span></label>
            
            <input type="text" name="importUsernameInput" class="form-control" id="importUsernameInput" required value="" autofocus>
              <b class="tooltip tooltip-top-right">
              <i class="fa fa-user txt-color-teal"></i> Please enter Instance Username</b>
          
        
          </div>
      
          <div class="col-lg-6" style="margin-top:20px;">
            <label for="">Choose Authentication Type</label>
            <select id="pemFileDropdown2"  class="authenticationType width-100" cdata="catalyst" cat-validation="required">
              <option value="password">Password</option>
              <option value="pemFile">Pem File</option>
            </select>
          
          </div>

          
      
      <div class="col-lg-6" style="display:none">
        
          <label for="exampleInputEmail1">Provider</label>
          
          <select id="puppetImportProviderSelect"  class="form-control" cat-validation="required">
                
          </select>
        
        
      </div>
      
      
      <div class="col-lg-6 credentialSection authPassword" style="margin-top:20px;">
        
          <label for="exampleInputEmail1">Password</label>
          
          <input type="password" class="form-control" id="importPasswordInput" required="true" cdata="catalyst" cat-validation="required"><span data-val-controltovalidate="orgname" id="MainContent_Req_orgname" data-val="true" data-val-initialvalue="" style="visibility:hidden;">Required</span>
            <b class="tooltip tooltip-top-right">
            <i class="fa fa-lock txt-color-teal"></i> Please enter Instance Password</b>
          
        
      </div>

      <div class="col-lg-6 credentialSection authPemFile" style="margin-top:20px;">
        <div class="smart-forms">
            <label for="exampleInputEmail1">Pem File</label>
            <label for="" name="field" class="file">
                <span class="button btn-primary">Browse</span>
                <input id="importPemfileInput" type="file" class="gui-file">
                <input type="text" readonly="" class="gui-input">
            </label>
        </div>
      </div>

     
      <div class="col-lg-6 hidden" style="margin-top:15px;">
          <label class="">Assign Users<span class="control-label redSpan">&nbsp;*</span></label>
          
              <div class="userListLoadingContainer"></div>
              <select class="custom-scroll" multiple="" id="userListSelect" style="display:none" cdata="catalyst" cat-validation="required">
                  <option value="1">User1</option>
                  <option value="2">User2</option>
                  <option value="3">User3</option>
                  <option value="4">User4</option>
                  <option value="5">User5</option>
              </select> 
          
      </div>
    
    
         
      </div>
      <div class="modal-footer">
          <div class="marginForButtons">
            <label id="saveSpinner" class="hidden"><img  style="margin-left:5px;margin-right:25px;" src="img/select2-spinner.gif"></label>
          <a type="button" class="btn btn-default" data-dismiss="modal">Close</a>
          <button type="button" class="btn btn-primary importNodesBtn">Import</button>
        </div>
      </div>
      </form>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="chefImportNodesResultModal" data-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title">Importing Nodes</h4>
      </div>
      <div class="modal-body">
      </div>
       <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript">

$(document).ready(function(){
  var hasChefImportPermission = false;
   if(haspermission("instancelaunch","execute")){
    hasChefImportPermission=true;
   }
   if(!hasChefImportPermission){
      $('#buttonForIP').addClass('hidden');
   }
});



$('#buttonForIP').click(function(e){
  $('#saveSpinner').addClass('hidden');
  $('.importNodesBtn').removeAttr('disabled');
  var perm = haspermission('instancelaunch','execute');
  
  //alert(perm);
  if(!perm)
  {
    
    bootbox.alert('Insufficient permission to perform operation.');
    $('#chefImportNodesModal').modal('hide');
    return;
  }
  else{
     var $checkBoxes = $('.nodeCheckBox:checked');
     if (!$checkBoxes.length) {
        alert('Please Choose nodes first');
        return;
     }
    $('#chefImportNodesModal').modal('show');
    $('#puppetImportBgSelect').select2('val', 'All');
    $('#puppetImportProjectSelect').select2('val', 'All');
    $('#myForm12').trigger("reset");
    $('#pemFileDropdown2').change();
    }
});

$(document).ready(function() {
    $('#pemFileDropdown2').select2();
    $('#puppetImportBgSelect').select2();
    $('#puppetImportProjectSelect').select2();
    $('#puppetImportEnvSelect').select2();
    $(document).on('shown.bs.modal', function(e) {
      $('[autofocus]', e.target).focus();
    });
});

$(".authPassword").show();
$(".authPemFile").hide();
$('.authenticationType').change(function(e) {
    if (this.value == "password") {
        $(".authPassword").show();
        $(".authPemFile").hide();
    } else {
        $(".authPassword").hide();
        $(".authPemFile").show();
    }
});



drawBreadCrumb1();
var urlParams = {};
(window.onpopstate = function() {
    var url = window.location.href;
    var indexOfQues = url.lastIndexOf("?");
    if (indexOfQues != -1) {
        var sub = url.substring(indexOfQues + 1);
        console.log(sub);
        urlParams.puppetServerId = sub;

    }

})();
$(function() {

    var $orgListInput = $('#puppetImportOrgSelect');
    var $bgList = $('#puppetImportBgSelect');
    var $projectList = $('#puppetImportProjectSelect');
    var $envList = $('#puppetImportEnvSelect');


    $('.nodeListContainer').append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />');

    $.get('../puppet/' + urlParams.puppetServerId, function(data) {
        console.log('chefServer ==>', data);
        $orgListInput.append($('<option></option>').val(data.orgname_rowid[0]).html(data.orgname[0]).attr('selected', 'selected'));
        $orgListInput.select2();
        // var getProviders = getRelatedValues_Top(9, "providername", '', "providername");
        // var $providerlist = $('#puppetImportProviderSelect');
        // $providerlist.append($('<option></option>').val('choose').html('Choose'));
        // for (var i = 0; i < getProviders.length; i++) {
        //     $providerlist.append($('<option></option>').val(getProviders[i]).html(getProviders[i]));
        // }
        // $providerlist.append($('<option></option>').val('azure').html('Azure Data Center'));
        // $providerlist.append($('<option></option>').val('datacenter').html('Data Center'));

        // $providerlist.change(function(e) {
        //     var val = $providerlist.val();
        //     if (val == 'datacenter' || val == 'azure') {
        //         $('.credentialSection').show();
        //     } else {
        //         $('.credentialSection').hide();
        //     }


        // });

        $bgList.empty();
        $bgList.append($('<option></option>').val('choose').html('Choose'));
        //alert('Org Rowid' + data.orgname_rowid);
        var getBGs = getRelatedValues_Top(2, "orgname_rowid", data.orgname_rowid[0], "productgroupname");
        //alert('getBGs ' + JSON.stringify(getBGs));
        for (var i = 0; i < getBGs.length; i++) {
            if(getBGs[i].indexOf('|') >= 0)
            {
              var txtval = getBGs[i].split('|');
              $bgList.append($('<option></option>').val(txtval[0]).html(txtval[1]));
            }
            
        }



        $bgList.change(function(e) {
            var bgName = $(this).val();
            if (bgName == 'choose') {
                return;
            }
            $projectList.empty();
            $projectList.append($('<option></option>').val('choose').html('Choose'));

            var getProjs = getRelatedValues_Top(4, "productgroupname_rowid", bgName, "projectname");
            // alert(JSON.stringify(getProjs));
            for (var i = 0; i < getProjs.length; i++) {
               if(getProjs[i].indexOf('|') >= 0)
                {
                    var txtval = getProjs[i].split('|');
                    $projectList.append($('<option></option>').val(txtval[0]).html(txtval[1]));
                }
            }
        });
        $projectList.change(function(e) {
            var projName = $(this).val();
            if (projName == 'choose') {
                return;
            }
            var getEnvs_ = getRelatedValues_Top_rowid(4, "rowid", projName, "environmentname");
            //debugger;
            //alert(JSON.stringify(getEnvs_));
            var getEnvs = getEnvs_.toString().replace(/"/g, '').split(',');
            // alert(getEnvs.length);
            // var getEnvs = JSON.parse(getEnvs_);
            for (var i = 0; i < getEnvs.length; i++) {
              if(getEnvs[i].indexOf('|') >= 0)
                {
                    var txtval = getEnvs[i].split('|');
                   $envList.append($('<option></option>').val(txtval[0]).html(txtval[1]));
                  // alert('Env: ' + txtval[0] + ' ' +  txtval[1]);
                }
            }
        });

      
        $.get('../puppet/'+urlParams.puppetServerId + '/nodes', function(nodeList) {
            $('.nodeListContainer img').remove();

            var $tableBody = $('.table-hover tbody');

            //restricting to first 5 to change the below to nodeList.length
            for (var i = 0; i < nodeList.length; i++) {
                var $tr = $('<tr></tr>').addClass('show-settings').attr('data-nodeName', nodeList[i]);
                $tr.append($('<td></td>').addClass('puppet-nodeName').append(nodeList[i]));
                 $tr.append($('<td></td>').addClass('chef-ip').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
                // $tr.append($('<td></td>').addClass('chef-fqdn').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
                $tr.append($('<td></td>').addClass('chef-platform').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
                // $tr.append($('<td></td>').addClass('chef-uptime').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));

                $tr.append($('<td></td>').addClass('chef-env').append('<img class="center-block" style="height:20px;width:20px;" src="img/loading.gif" />'));
                
                $nodecheckboxlabel = $('<label></label>').addClass('checkbox');
                $nodecheckboxinput = $('<input class="nodeCheckBox smart-form" data-nodeName="' + nodeList[i] + '" type="checkbox" name="nodesChecked"/><i class="margin-left40per"></i>');
                $nodecheckboxlabel.append($nodecheckboxinput);

                // $tr.append($('<td></td>').addClass('chef-checkbox').append($('<input class="nodeCheckBox" data-nodeName="'+nodeList[i]+'" type="checkbox" name="nodesChecked"/>'))); 
                $tr.append($('<td></td>').addClass('chef-checkbox smart-form').append($nodecheckboxlabel));
                $tr.find('td').css({
                    'text-align': 'center'
                });
                $tableBody.append($tr);


                (function(nodeName) {
                    $.get('../puppet/' + urlParams.puppetServerId + '/nodes/' + nodeName, function(node) {
                        var $tr = $tableBody.find('tr[data-nodeName="' + node.name + '"]');

                        var nodeValues;

                        if (node.facts && node.facts.values) {
                            nodeValues = node.facts.values;
                        } else if (node.parameters) {
                            nodeValues = node.parameters;
                        }


                        var ip = 'unknown';
                        if (nodeValues.ec2_public_ipv4) {
                            ip = nodeValues.ec2_public_ipv4;
                        } else {
                            ip = nodeValues.ipaddress;
                        }

                        $tr.find('.chef-ip').empty().append('<span>' + ip + '</span>');

                        /*
                    var fqdn = 'unknown';
                    if (node.automatic.fqdn) {
                        fqdn = node.automatic.fqdn;
                    }
                    $tr.find('.chef-fqdn').empty().append('<span>' + fqdn + '</span>');
                    */

                        var platform = 'unknown';
                        if (nodeValues.operatingsystem) {
                            platform = nodeValues.operatingsystem;
                        }
                        $tr.find('.chef-platform').empty().append('<span>' + platform + '</span>');

                        /*
                    var uptime = 'unknown';
                    if (node.automatic.uptime) {
                        uptime = node.automatic.uptime;
                    }
                    $tr.find('.chef-uptime').empty().append('<span>' + uptime + '</span>');
                    */



                        var environment = 'unknown';
                        if (node.environment) {
                            environment = node.parameters.environment;
                        }
                        /*var $tempenv = $envselect.clone();
                    $tempenv.val(environment).attr('currentEnv', environment);
                    $tempenv.change(function() {
                        if ($(this).val() == $(this).attr('currentEnv')) {
                            return;
                        }
                        $that = $(this);
                        bootbox.confirm("Are you sure you would want to change the environment?<br/>Note:<br/>Change will done on the chef server.", function(result) {
                            if (result) {
                                var nodeName = $that.parents('tr').attr('data-nodeName');
                                $.post('/chef/servers/' + urlParams.chefId + '/nodes/' + nodeName + '/updateEnv', {
                                    envName: $that.val()
                                }, function(res) {
                                    console.log(res);
                                    $that.attr('currentEnv', $that.val());
                                }).fail(function() {
                                    bootbox.alert('Unable to change environment. Please try again later');
                                    $that.val($that.attr('currentEnv'));
                                    $that.change();
                                });
                                return;
                            } else {
                                $that.val($that.attr('currentEnv'));
                                $that.change();
                            }
                        });

                    });


                    $tr.find('.chef-env').empty().append($tempenv); 
                    $tr.find('.envselect').select2();
                    */

                        $tr.find('.chef-env').empty().append('<span>' + environment + '</span>');
                        $tr.find('.nodeCheckBox').data('node', node);

                    }).fail(function(jxhr) {
                        //console.log(jxhr);
                        var $tr = $tableBody.find('tr[data-nodeName="' + nodeName + '"]');
                        $tr.find('td:not(.puppet-nodeName)').html('error');
                    });
                })(nodeList[i]);


            }


            $('#organiz').show();

        }).fail(function(jxhr) {
            var $nodeListContainer = $('.nodeListContainer');
            $nodeListContainer.find('img').remove();
            var $spanError = $('<span></span>').css({
                color: 'red',
                'margin-left': '39%'
            });
            if (jxhr.responseJSON) {
                $spanError.html(jxhr.responseJSON.message);
            } else {
                $spanError.html("Server Behaved Unexpectedly");
            }
            $nodeListContainer.append($spanError);
        }); //end get '../chef/servers/'

    });

    var serviceURL = "../d4dMasters/";

    function getRelatedValues_Top(jsonID, comparedField, filterByValue, outputField) {
        var result = [];
        readMasterJson_Top(jsonID);
        //formData = d4ddata.masterjson;
        //alert('Top' + JSON.stringify(d4ddata));
        if (d4ddata) {
          //alert('grvt:' + JSON.stringify(d4ddata))  ;
            $.each(d4ddata, function(k, v) {
                
                if (v[comparedField] == filterByValue && v[outputField]) {
                    result.push(v['rowid'] + '|' + v[outputField]);
                }

            });

        }
        //alert(result.toString());
        return (result);
    }
    function getRelatedValues_Top_rowid(jsonID, comparedField, filterByValue, outputField) {
        var result = [];
        readMasterJson_Top(jsonID);
        //formData = d4ddata.masterjson;
        //alert('Top' + JSON.stringify(d4ddata));
        if (d4ddata) {
          //alert('grvt:' + JSON.stringify(d4ddata))  ;
            $.each(d4ddata, function(k, v) {
                
                if (v[comparedField] == filterByValue && v[outputField]) {
                    var rowids = v[outputField + '_rowid'].split(',');
                    var txts = v[outputField].split(',');
                    for(var i =0; i < txts.length;i++){
                      result.push(rowids[i] + '|' + txts[i]);
                    }
                    
                }

            });

        }
        //alert(result.toString());
        return (result);
    }


    function getRelatedValues_Top__old(jsonID, comparedField, filterByValue, outputField) {
        var result = [];

        readMasterJson_Top(jsonID);
        formData = d4ddata.masterjson;
        // var comparedField = "orgname";
        //  var filterByValue = "Scholastic";
        //  var outputField = "productgroupname";

        //debugger;
        $.each(eval(formData.rows.row), function(i, item) {
            $.each(item.field, function(k, item1) {

                if (item1.name == comparedField && (item1.values.value == filterByValue || filterByValue == '')) {
                    // alert(item1.values.value);
                    //found the row, now get the next column
                    // debugger;
                    $.each(item.field, function(j, item2) {
                        if (item2.name == outputField) {
                            //  alert(item2.values.value);
                            result.push(item2.values.value);
                        }
                    });
                }
            });
        });
        //alert(jsonID + ' ' + result.toString());
        return (result);
    }

    function readMasterJson_Top_old(section) {

        $.ajax({
            type: "get",
            dataType: "text",

            async: false,
            url: serviceURL + "readmasterjson/" + section,
            success: function(data) {
                // alert(data.toString());   
                d4ddata = JSON.parse(data);
            },
            failure: function(data) {
                alert(data.toString());
            }
        });
        return (d4ddata);
    }

    function readMasterJson_Top(section) {
        //alert(serviceURL + "readmasterjsonnew/" + section);
        $.ajax({
            type: "get",
            dataType: "text",
            async: false,
            url: serviceURL + "readmasterjsonnew/" + section,
            success: function(data) {
               // alert(JSON.stringify(data));   
                d4ddata = JSON.parse(data);
            },
            failure: function(data) {
                alert(data.toString());
            }
        });
        return (d4ddata);
    }


    /*$('.showChefImportNodesModalBtn').click(function(e) {
        var $checkBoxes = $('.nodeCheckBox:checked');
        if (!$checkBoxes.length) {
            alert('Please Choose nodes first');
            return;
        }
        //$('#chefImportNodesModal').modal('show');
    });*/
    $('#importPemfileInput').change(function() {
        //console.log(this.files);
        $(this).next().val(this.files[0].name);
    });
    $('.importNodesBtn').click(function(e) {
        var $checkBoxes = $('.nodeCheckBox:checked');
        var reqBody = {};
        reqBody.orgId = $orgListInput.val();
        reqBody.orgName = $orgListInput.find("option:selected").text();
        reqBody.bgId = $bgList.val();
        reqBody.projectId = $projectList.val();
        reqBody.projectName = $projectList.find("option:selected").text();
        reqBody.envID = $envList.val();
        /*if(!reqBody.bgId || !reqBody.bgId.length){
    alert('Please Select Business Groups & Project');
    return;
   }*/

      if (!((reqBody.bgId && reqBody.bgId.length) && (reqBody.projectId && reqBody.projectId.length) && reqBody.projectId !== 'choose' && reqBody.bgId !== 'choose')) {
            alert('Please Select a Business Group & Project');
        return;
        }



        reqBody.selectedNodes = [];
        $checkBoxes.each(function() {
            reqBody.selectedNodes.push($(this).attr('data-nodeName'));
        });

        reqBody.credentials = {};
        reqBody.credentials.username = $('#importUsernameInput').val();

        var $dropdown = $('#pemFileDropdown2');
        if (!($dropdown.val() === 'pemFile')) {
            reqBody.credentials.password = $('#importPasswordInput').val();
            if (!reqBody.credentials.username) {
                alert('Please Enter Username');
                return;
            }
            if (!reqBody.credentials.password) {
                alert('Please Enter Password or Choose a Pem file');
                return;
            }
            reqBody.users = $('#userListSelect').val();
            if (!reqBody.users || !reqBody.users.length) {
                alert('Please Choose Users');
                return;
            }
            console.log(reqBody);

            makeRequest();
        } else {
            var pemFileInput = $('#importPemfileInput').get(0);
            if (!reqBody.credentials.username) {
                alert('Please Enter Username');
                return;
            }
            if (!pemFileInput.files.length) {
                alert('Please Choose a Pem file');
                return;
            }

            reqBody.users = $('#userListSelect').val();
            if (!reqBody.users || !reqBody.users.length) {
                alert('Please Choose Users');
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                // Render thumbnail.
                reqBody.credentials.pemFileData = e.target.result;

                makeRequest();

            };
            // Read in the image file as a data URL.
            reader.readAsText(pemFileInput.files[0]);

        }

        function makeRequest() {
            $('#saveSpinner').removeClass('hidden');
            $('.importNodesBtn').attr('disabled', 'disabled');
            console.log(reqBody);
            $.post('../puppet/' + urlParams.puppetServerId + '/sync/nodes', reqBody, function(data) {
                console.log(data);
                var $chefResultModalContainer = $('#chefImportNodesResultModal');
                var $modalBody = $chefResultModalContainer.find('.modal-body');
                $modalBody.empty();
                var $progressBar = $('<progress value="0" max="' + reqBody.selectedNodes.length + '"></progress>').css({
                    width: '100%'
                });
                var $msgDiv = $('<div class="messageDiv"></div>').css({
                    width: '100%'
                });

                $modalBody.append($progressBar).append($msgDiv);
                $('#saveSpinner').addClass('hidden');

                $('#chefImportNodesModal').modal('hide');
                $chefResultModalContainer.modal('show');
                var timeout;
                var count = 0;

                function pollTaskStatus(taskId, timestamp) {
                    timeout = setTimeout(function() {
                        $.get('../taskstatus/' + taskId + '/status?timestamp=' + timestamp, function(data) {
                            console.log(data);
                            if (!data.completed) {
                                if (data.statusList && data.statusList.length) {

                                    $progressBar.val(data.statusList.length);
                                    $msgDiv.empty();
                                    for (var i = 0; i < data.statusList.length; i++) {
                                        $msgDiv.append($('<div></div>').append(data.statusList[i].status.message));
                                    }

                                    pollTaskStatus(taskId, data.statusList[data.statusList.length - 1].timestamp);
                                } else {
                                    pollTaskStatus(taskId, timestamp);
                                }
                            } else {
                                if (data.statusList && data.statusList.length) {
                                    $progressBar.val(data.statusList.length);
                                    $msgDiv.empty();
                                    for (var i = 0; i < data.statusList.length; i++) {
                                        $msgDiv.append($('<div></div>').append(data.statusList[i].status.message));
                                    }
                                }
                                $progressBar.val(reqBody.selectedNodes.length);
                                if (reqBody.selectedNodes.length) {

                                    var nodeData = $($checkBoxes[0]).data('node');
                                    if (nodeData && nodeData.chef_environment) {
                                        //$chefResultModalContainer.modal('hide');
                                        loadTreeFuncNew();
                                        //window.location.href = '#ajax/Dev.html?org='+reqBody.orgId+'&projid='+reqBody.projectId+'&envid='+nodeData.chef_environment;

                                    }
                                }
                            }
                        })
                    }, 1000);

                }
                pollTaskStatus(data.taskId, 0);
                //Refreshing the workzone tree

            }).error(function() {
                alert('Unable to import instances. Please try again later');
            });
        }

    });

});


(function() {
  
    var $loadingContainer = $('.userListLoadingContainer').empty().append('<img class="center-block" style="height:50px;width:50px;margin-top: 10%;margin-bottom: 10%;" src="img/loading.gif" />').show();
    $.get('../users', function(userList) {
        var $userListSelect = $('#userListSelect').empty();
        userList = JSON.parse(userList);
        userList.sort(function(a, b) {
            var keyA = Object.keys(a);
            var keyB = Object.keys(b);

            if (keyA[0] < keyB[0]) return -1;
            if (keyA[0] > keyB[0]) return 1;
            return 0;
        });
        for (var i = 0; i < userList.length; i++) {
            var keys = Object.keys(userList[i]);
            var $option = $('<option></option>').append(keys[0]).val(keys[0]);
            if(sessionUser.cn){
              if(keys[0] == sessionUser.cn)
                $option.attr('selected','selected');
            }
            $userListSelect.append($option);
        }

        $loadingContainer.hide();
        $userListSelect.show();
        
         
    }).error(function() {
        $loadingContainer.empty().append('Unable to load users. Please try again later.');
    });
})();


</script>
<script>
var b = $('#tabContent tr td').width();
var c = $('#tabContent tr ').width();
b = c;
$('.tabContent tr').find('span').on('click', function() {
    var w = $(this).width();
    var h = $(this).height();
    var a = $(this).html();
    $(this).hide();
    $(this).parent().children('input').show().focus().val(a);
    $(this).parent().children('input').css({
        "width": w + 'px'
    });
});

$('.tabContent tr').find('input').on('blur', function() {
    var inputVal = $(this).val();
    $(this).hide();
    $(this).parent().children('span').show().html(inputVal);
});
</script>

<script>
$(document).ready(function() {

    $('#myForm12').submit(function() {
      
        $(this).validate();


        if ($(this).valid) {
            /*alert('valid form submitted'); // for demo*/
            if (!saveform('12')) return false;;
        } else {
            alert('invalid valid form submitted'); // for demo
        }
        return false; // for demo
    });
});
</script>